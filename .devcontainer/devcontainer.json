# syntax=docker/dockerfile:1
ARG VARIANT="22.04"
FROM mcr.microsoft.com/devcontainers/base:ubuntu-${VARIANT}

######################################################################
# ---- versions that match your CI log ------------------------------
######################################################################
ARG FLUTTER_VERSION=3.24.0
ARG ANDROID_PLATFORM=34           # gives platforms;android-34
ARG BUILD_TOOLS_VERSION=33.0.1
ARG NDK_VERSION=26.3.11579264
######################################################################

ENV DEBIAN_FRONTEND=noninteractive
USER root

# ---------- core packages ------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl wget unzip git git-lfs ca-certificates \
        openjdk-17-jdk \
        zlib1g-dev libgl1-mesa-dev clang cmake ninja-build pkg-config && \
    rm -rf /var/lib/apt/lists/*

# ---------- Android SDK --------------------------------------------
ENV ANDROID_SDK_ROOT=/opt/android-sdk-linux
RUN mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools" && \
    curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip \
      -o /tmp/cmdline-tools.zip && \
    unzip -q /tmp/cmdline-tools.zip -d "${ANDROID_SDK_ROOT}/cmdline-tools" && \
    mv "${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools" \
       "${ANDROID_SDK_ROOT}/cmdline-tools/latest" && \
    rm /tmp/cmdline-tools.zip

ENV PATH=${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:$PATH

# Accept licenses + install the exact bits your Actions run pulled
RUN yes | sdkmanager --licenses > /dev/null && \
    sdkmanager "platform-tools" \
               "platforms;android-${ANDROID_PLATFORM}" \
               "build-tools;${BUILD_TOOLS_VERSION}" \
               "ndk;${NDK_VERSION}" \
               "patcher;v4"

# ---------- Flutter -------------------------------------------------
ENV FLUTTER_HOME=/opt/flutter
RUN git clone --depth 1 --branch "${FLUTTER_VERSION}" \
      https://github.com/flutter/flutter.git "${FLUTTER_HOME}"

ENV PATH=${FLUTTER_HOME}/bin:$PATH
RUN flutter config --no-analytics && flutter precache

# ---------- non-root user (Codespaces default) ----------------------
ARG USERNAME=vscode
ARG USER_UID=1000
ARG USER_GID=1000
RUN groupadd --gid $USER_GID $USERNAME \
    && useradd  --uid $USER_UID --gid $USER_GID -m $USERNA
